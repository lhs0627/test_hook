#!/bin/bash
###############################################################################
# Pre-commit hook: Check for Chinese characters in staged code files
# Excludes i18n internationalization content from validation
# Compatible with macOS and Linux
###############################################################################

set -e

# Color codes for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

echo -e "${GREEN}Running pre-commit Chinese character check...${NC}"

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(js|jsx|ts|tsx|py|java|go|rs|c|cpp|h|css|scss|less|vue|json|yaml|yml)$' || true)

if [ -z "$STAGED_FILES" ]; then
    echo "No code files staged for commit."
    exit 0
fi

# Track if any violations found
HAS_VIOLATIONS=0

# Function to check file for Chinese characters
check_chinese_in_file() {
    local file="$1"
    local line_number=0
    local violations=()

    # Get the staged content of the file
    while IFS= read -r line; do
        ((line_number++))

        # Use Python to check if line has Chinese (excluding i18n patterns)
        result=$(python3 - "$line" << 'PYTHON_CODE'
import sys
import re

line = sys.argv[1] if len(sys.argv) > 1 else ""

def has_chinese(text):
    return bool(re.search(r"[\u4e00-\u9fa5]", text))

def is_i18n_pattern(line):
    patterns = [
        r"t\(['\"].*[\u4e00-\u9fa5]+.*['\"]\)",
        r"i18n\.t\(['\"].*[\u4e00-\u9fa5]+.*['\"]\)",
        r"\$t\(['\"].*[\u4e00-\u9fa5]+.*['\"]\)",
        r"formatMessage\s*\([^)]*defaultMessage:\s*['\"].*[\u4e00-\u9fa5]+",
        r"intl\.\w+.*[\u4e00-\u9fa5]+",
        r"trans\(['\"].*[\u4e00-\u9fa5]+.*['\"]\)",
        r"_translate\(['\"].*[\u4e00-\u9fa5]+.*['\"]\)",
        r"gettext\(['\"].*[\u4e00-\u9fa5]+.*['\"]\)",
        r"_\(['\"].*[\u4e00-\u9fa5]+.*['\"]\)",
    ]
    for pattern in patterns:
        if re.search(pattern, line):
            return True
    return False

if not is_i18n_pattern(line) and has_chinese(line):
    print(line)
PYTHON_CODE
)

        if [ -n "$result" ]; then
            violations+=("$line_number:$line")
        fi
    done < <(git diff --cached "$file" | grep -E '^\+' | sed 's/^\+//' | grep -v '^+++' || true)

    # Output violations
    if [ ${#violations[@]} -gt 0 ]; then
        echo -e "\n${RED}Chinese characters found in: ${YELLOW}$file${NC}"
        for violation in "${violations[@]}"; do
            local ln="${violation%%:*}"
            local content="${violation#*:}"
            echo -e "  ${YELLOW}Line $ln:${NC} $content"
        done
        return 1
    fi

    return 0
}

# Check each staged file
for file in $STAGED_FILES; do
    if [ -f "$file" ]; then
        if ! check_chinese_in_file "$file"; then
            HAS_VIOLATIONS=1
        fi
    fi
done

# Final result
if [ $HAS_VIOLATIONS -eq 1 ]; then
    echo -e "\n${RED}Commit blocked: Chinese characters found in code.${NC}"
    echo -e "${YELLOW}Please remove Chinese characters or move them to i18n files.${NC}"
    echo -e "${YELLOW}Common i18n patterns like t(), \$t(), i18n.t() are automatically excluded.${NC}"
    exit 1
fi

echo -e "${GREEN}No Chinese characters found in staged files.${NC}"
exit 0
